{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "Creates Data Collection Rule for Endpoint Forensics JSON log ingestion"
  },
  "parameters": {
    "dataCollectionRuleName": {
      "type": "string",
      "defaultValue": "dcr-endpoint-forensics",
      "metadata": {
        "description": "Name of the Data Collection Rule"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for resources"
      }
    },
    "workspaceResourceId": {
      "type": "string",
      "metadata": {
        "description": "Full resource ID of the Log Analytics workspace"
      }
    },
    "dataCollectionEndpointId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional: Resource ID of an existing Data Collection Endpoint. Leave empty to use DCR-based endpoint."
      }
    }
  },
  "variables": {
    "workspaceName": "[last(split(parameters('workspaceResourceId'), '/'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2022-06-01",
      "name": "[parameters('dataCollectionRuleName')]",
      "location": "[parameters('location')]",
      "kind": "Windows",
      "properties": {
        "dataCollectionEndpointId": "[if(empty(parameters('dataCollectionEndpointId')), null(), parameters('dataCollectionEndpointId'))]",
        "description": "Data Collection Rule for Endpoint Forensics - collects NDJSON files from Windows endpoints",
        "streamDeclarations": {
          "Custom-EndpointForensics_Heartbeat_CL": {
            "columns": [
              { "name": "TimeGenerated", "type": "datetime" },
              { "name": "Computer", "type": "string" },
              { "name": "HostUUID", "type": "string" },
              { "name": "SnapshotId", "type": "string" },
              { "name": "ScriptVersion", "type": "string" },
              { "name": "CollectionStartTime", "type": "datetime" },
              { "name": "CollectionEndTime", "type": "datetime" },
              { "name": "CollectionDurationSeconds", "type": "real" },
              { "name": "ErrorCount", "type": "int" },
              { "name": "AutorunscAvailable", "type": "boolean" },
              { "name": "OutboxPath", "type": "string" }
            ]
          },
          "Custom-EndpointForensics_Processes_CL": {
            "columns": [
              { "name": "TimeGenerated", "type": "datetime" },
              { "name": "Computer", "type": "string" },
              { "name": "HostUUID", "type": "string" },
              { "name": "SnapshotId", "type": "string" },
              { "name": "ProcessId", "type": "int" },
              { "name": "ProcessName", "type": "string" },
              { "name": "ParentProcessId", "type": "int" },
              { "name": "UserName", "type": "string" },
              { "name": "CommandLine", "type": "string" },
              { "name": "ExecutablePath", "type": "string" },
              { "name": "StartTime", "type": "datetime" },
              { "name": "WorkingSet", "type": "long" },
              { "name": "CPU", "type": "real" },
              { "name": "HandleCount", "type": "int" },
              { "name": "ThreadCount", "type": "int" },
              { "name": "Company", "type": "string" },
              { "name": "ProductVersion", "type": "string" },
              { "name": "FileVersion", "type": "string" },
              { "name": "Description", "type": "string" }
            ]
          },
          "Custom-EndpointForensics_TcpConnections_CL": {
            "columns": [
              { "name": "TimeGenerated", "type": "datetime" },
              { "name": "Computer", "type": "string" },
              { "name": "HostUUID", "type": "string" },
              { "name": "SnapshotId", "type": "string" },
              { "name": "LocalAddress", "type": "string" },
              { "name": "LocalPort", "type": "int" },
              { "name": "RemoteAddress", "type": "string" },
              { "name": "RemotePort", "type": "int" },
              { "name": "State", "type": "string" },
              { "name": "OwningProcess", "type": "int" },
              { "name": "CreationTime", "type": "datetime" },
              { "name": "OffloadState", "type": "string" }
            ]
          },
          "Custom-EndpointForensics_Autorunsc_CL": {
            "columns": [
              { "name": "TimeGenerated", "type": "datetime" },
              { "name": "Computer", "type": "string" },
              { "name": "HostUUID", "type": "string" },
              { "name": "SnapshotId", "type": "string" },
              { "name": "EntryLocation", "type": "string" },
              { "name": "Entry", "type": "string" },
              { "name": "Enabled", "type": "string" },
              { "name": "Category", "type": "string" },
              { "name": "Profile", "type": "string" },
              { "name": "Description", "type": "string" },
              { "name": "Signer", "type": "string" },
              { "name": "Company", "type": "string" },
              { "name": "ImagePath", "type": "string" },
              { "name": "Version", "type": "string" },
              { "name": "LaunchString", "type": "string" },
              { "name": "MD5", "type": "string" },
              { "name": "SHA1", "type": "string" },
              { "name": "PESHA1", "type": "string" },
              { "name": "PESHA256", "type": "string" },
              { "name": "SHA256", "type": "string" },
              { "name": "IMP", "type": "string" }
            ]
          }
        },
        "dataSources": {
          "logFiles": [
            {
              "name": "EndpointForensics_Heartbeat",
              "streams": ["Custom-EndpointForensics_Heartbeat_CL"],
              "filePatterns": ["C:\\ProgramData\\EndpointForensics\\outbox\\Heartbeat.ndjson"],
              "format": "json",
              "settings": {
                "text": {
                  "recordStartTimestampFormat": "ISO 8601"
                }
              }
            },
            {
              "name": "EndpointForensics_Processes",
              "streams": ["Custom-EndpointForensics_Processes_CL"],
              "filePatterns": ["C:\\ProgramData\\EndpointForensics\\outbox\\Processes.ndjson"],
              "format": "json",
              "settings": {
                "text": {
                  "recordStartTimestampFormat": "ISO 8601"
                }
              }
            },
            {
              "name": "EndpointForensics_TcpConnections",
              "streams": ["Custom-EndpointForensics_TcpConnections_CL"],
              "filePatterns": ["C:\\ProgramData\\EndpointForensics\\outbox\\TcpConnections.ndjson"],
              "format": "json",
              "settings": {
                "text": {
                  "recordStartTimestampFormat": "ISO 8601"
                }
              }
            },
            {
              "name": "EndpointForensics_Autorunsc",
              "streams": ["Custom-EndpointForensics_Autorunsc_CL"],
              "filePatterns": ["C:\\ProgramData\\EndpointForensics\\outbox\\Autorunsc.ndjson"],
              "format": "json",
              "settings": {
                "text": {
                  "recordStartTimestampFormat": "ISO 8601"
                }
              }
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[parameters('workspaceResourceId')]",
              "name": "la-destination"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": ["Custom-EndpointForensics_Heartbeat_CL"],
            "destinations": ["la-destination"],
            "transformKql": "source",
            "outputStream": "Custom-EndpointForensics_Heartbeat_CL"
          },
          {
            "streams": ["Custom-EndpointForensics_Processes_CL"],
            "destinations": ["la-destination"],
            "transformKql": "source",
            "outputStream": "Custom-EndpointForensics_Processes_CL"
          },
          {
            "streams": ["Custom-EndpointForensics_TcpConnections_CL"],
            "destinations": ["la-destination"],
            "transformKql": "source",
            "outputStream": "Custom-EndpointForensics_TcpConnections_CL"
          },
          {
            "streams": ["Custom-EndpointForensics_Autorunsc_CL"],
            "destinations": ["la-destination"],
            "transformKql": "source",
            "outputStream": "Custom-EndpointForensics_Autorunsc_CL"
          }
        ]
      }
    }
  ],
  "outputs": {
    "dataCollectionRuleId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/dataCollectionRules', parameters('dataCollectionRuleName'))]"
    },
    "dataCollectionRuleImmutableId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', parameters('dataCollectionRuleName'))).immutableId]"
    }
  }
}
